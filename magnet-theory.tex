\documentclass[11pt,a4paper]{memoir}
\def\asydir{\jobname}
\usepackage{thesis-preamble}
\EndPreamble
\begin{document}

\chapter{Magnetic and electromagnetic forces}
\chaplabel{magnet-theory}

\epigraph{With an eye to the practical importance of levitation we
feel justified here in disregarding those aspects of it
associated with magic, spiritualism, and psychic
phenomena\dots}{\textcite{boerdijk1956b}}

\referpaper{The work presented in \secref{cyl-forces} is based on material that has been published as a journal paper~\cite{robertson2011-ietm}.}

\section{Magnetic fields}

The following is a brief introduction to the physics behind magnets, largely to introduce the notation used later in the thesis.

Magnetic fields are created by moving electrons.
A long straight wire will create a cylindrical-like magnet field, and a small loop will create a magnetic dipole.
Thus, an electron orbiting a proton is the smallest magnetic element.
This is a hydrogen atom.
In nature, however, hydrogen exists as H$_2$, two protons orbited by two electrons \dash and it happens that the two electrons orbit in opposite directions and the magnetic fields of each cancel each other out.
Most material is like this: basically, not magnetic.
However, there are a number of compounds that do retain an asymmetry in their electron composition, and this allows them to act magnetically under the right conditions.


\subsection{Magnetic parameters}
\seclabel{bhm}

The magnetic dipole is designated as the microscopic quantity
$\mdip = \current\vecarea$, for a current $\current$ and a vector area $\vecarea$
(direction normal to plane). For a collection of magnetic dipoles (as
in a permanent magnet) in a vanishingly small volume $\volume$, their net effect may be quantified with the
macroscopic magnetisation of the material, $\magM$:
\begin{dmath}
  \magM =  \lim_{\volume \rightarrow 0} \frac{\sum \mdip}{\volume}  \eqlabel{M}
\end{dmath}.
Permanent magnets are generally analysed under the assumption that their magnetisation $\magM$ is homogeneous throughout the volume.
Inside the magnet itself (with no other external fields present), the magnetic field, $\magB$, is given by the relation \cite{campbell1994}
\begin{dmath}[label=BM]
  \magB = \permVac \magM
\end{dmath},
where the proportionality constant $\permVac$ is known as the permeability of the vacuum.

The equivalence of the magnetic field produced by a current-carrying coil and a permanent magnet is well established.
Therefore, it is possible to consider the magnetisation of a permanent magnet to be the result of an (abstract) surface current density $\magJm$ defined by
\begin{dmath}
  \magJm = \curl\magM
\end{dmath}.
This is a good starting point for describing the magnetic effects of an external current density $\magJ$ acting on a magnet.
To differentiate between such an induced magnetic field and that caused spontaneously by the magnetic material $\magM$, the induced magnetic field is denoted $\magH$, defined equivalently
\begin{dmath}
  \magJ = \curl\magH
\end{dmath}.
These three terms involving magnetic field can now be related to account for both internal and external forms of magnetisation (\ie, magnetic field caused by permanent magnets or by current carrying conductors) as \cite{campbell1994}
\begin{dmath}[label=BHM]
  \magB = \permVac (\magM + \magH)
\end{dmath}.
To clarify, $\magB$ is referred to as the magnetic flux density, $\magH$ is the magnetic field strength, and $\magM$ is the magnetisation.
\note{The names of these terms are not always consistent in the
  literature. $\magM$ is also known as polarisation, and $\magB$ and $\magH$
  are both sometimes known as the magnetic field in different contexts.}

\Eqref{BHM} may now be used to describe the situation at all points in space (\figref{BHM}).
In the presence of an external magnetic field, the magnetic flux density $\magB$ inside a permanent magnet is the vector sum of $\magH$ and $\magM$, whereas outside the magnet,  the magnetisation $\magM=0$ and the magnetic flux density $\magB$ is related to the magnetic field strength $\magH$ by a constant.
This results in $\magB$ being continuous everywhere, and both $\magM$~and $\magH$ being discontinuous.

\begin{figure}[htbp]
   \centering
   \includegraphics{PhD/Figures/Theory/BHM}
   \caption{The magnetic field, $\magB$, both inside and outside a magnet.}
   \figlabel{BHM}
\end{figure}


\subsection{Relationship between magnetic parameters}

The relationship established by \eqref{BHM} is true only for ideal permanent magnets whose own internal composition is not affected by an applied magnetic field, nor does it provide information about other materials in the presence of a magnetic field.
Within such materials, there may be some relationship between the applied magnetic field strength and the resultant magnetic flux density, which is described by the permeability $\perm$ of a material where
  \begin{dmath}[label=perm]
    \perm = \frac{\magB}{\magH}
  \end{dmath}.
The permeability for materials with a non-negligible magnetic interaction will not necessarily be constant with applied field strength or temperature, and for anisotropic materials the permeability will be direction-dependent.
It is often convenient to express permeability as a relative measure
  \begin{math}
    \permrel = \frac{\perm}{\permVac}
  \end{math},
known as the relative permeability.

The relative permeability of the vacuum is unity, and materials considered `non-magnetic' such as air, wood, water, and so on, have permeabilities very close to unity (within \num{1e-5}) as a result.
(The consequences of permeability less than unity, diamagnetism, has been discussed on page~\pageref{sec:diamag}.)
Materials which are more strongly affected by magnetic fields have greater permeabilities; \eg, within the soft iron core of an electromagnet, current in the coil generates an applied magnetic field on the core, which induces its own internal magnetic field as a result, and which increases the overall strength of the electromagnet. The larger the permeability, the larger this `amplification' effect.
Despite having strong remanence and coercivity values, rare earth magnets have a relative permeability of $\permrel=\num{1.05}$.

Refering to \eqref{BHM} in free space where $\magM=0$ the relationship between $\magB$ and $\magH$ is quite simple, which is essentially the reason that there is a historical terminological confusion between the two.
It can be seen that within a magnet, however, their relationship is more complex and important.
Consider a magnetic material which has not yet been magnetised.
As an external magnetic field is applied to it, the magnetic dipoles within the material begin to align along the direction of the applied field.
If the external magnetic field is sufficiently large, the material becomes completely magnetised (such that all of its dipoles are in alignment) and this magnetisation will be retained even once the applied magnetic field is removed.
If the magnetic field is increased further, the magnitude of magnetisation of the magnet cannot increase, and it is thus said to be `saturated'; this saturation magnetisation is denoted $\Msat$.
This process is conducted under high temperatures; once the magnetic material cools (with the applied magnetic field still in place) the magnetisation `sets' and the magnet is formed.
This magnetisation is retained unless a large demagnetisation field (which is simply a magnetic field applied in the opposite direction to its magnetisation) is applied to it or the magnet is heated sufficiently to allow its magnetic dipoles to lose their alignment due to thermal effects.

The performance of a magnet is linked to its behaviour under demagnetisation, as a strong magnet that demagnetises easily is of little use in practical application.
The behaviour is shown by the \bhcurve/ of the magnetic material, an example of which is shown for an ideal magnet in \figref{BHcurve}.
Two important features are shown in the \bhcurve/ indicated in \figref{BHcurve}.
First, the remanence of the magnet, $\remanence=\permvac\Msat$, is the value used to indicate the `strength' of the magnet alone corresponding to its saturation magnetisation.
The remanence refers to the amount of magnetic flux density that is measured in the absence of an applied external magnetic field, and it is a common term in practice since the internal magnetisation of a magnet $\Msat$ cannot be measured directly.

The second feature of interest on the \bhcurve/ is the coercivity, $\coerce$, which is the amount of magnetic field strength required to reduce the magnetic flux density within the magnet to zero.
The larger the coercivity, the greater the ability of a permanent magnet to resist demagnetisation due to the influence of external magnetic fields.
For the purposes of this thesis, rare earth magnets will be considered which have sufficiently large coercivities to avoid demagnetisation effects.

For theoretical magnetic force analysis (covered in \secref{magnet-forces} and later), the `strength' value to model the permanent magnets is defined in practice by the remanence of the magnet.
For cases such as finite element analysis, it can be necessary to instead define the permeability and coercivity of the magnets.
In which case, it can be convenient to calculate the coercivity with the relation
\begin{dmath}
\coerce = \frac{\remanence}{\perm\permvac}
\end{dmath}.

\begin{figure}[htbp]
   \centering
   \includegraphics{Figures/BHcurve}
   \caption{The characteristic $\magB$ \vs\ $\magH$ curves for an ideal rare-earth magnet.}
   \figlabel{BHcurve}
\end{figure}

As well as the remanence $\remanence$ and coercivity $\coerce$, two other parameters are often used to describe the `strength' of a permanent magnet.
The first is known as the `maximum energy product' $\BHmax$, relating to the amount of potential energy that can be supplied by the magnetic field in the second quadrant of the \bhcurve/.
In an ideal magnet, $\BHmax$ is directly related to its saturation magnetisation via \cite{campbell1994}
\begin{dmath}[label=bhmax]
  -\BHmax = \permvac\gp{\frac{\Msat}{2}}^2
\end{dmath}.
The final term is known as `intrinsic coercivity' $\coerce{}_i$, which is the magnetic field strength required to completely magnetise a magnetic domain (\ie, a collection of dipoles) or to completely reverse the polarity of magnetisation for the same.
Since a permanent magnet is made up of a very large number of magnetic domains, the magnetic field strength used to initially magnetise a permanent magnet is said to be around $5\coerce{}_i$ as a rule of thumb.


\subsection{Properties of magnetic flux}
\seclabel{flux}

The previous section introduced $\magB$, the magnetic flux density.
`Magnetic flux' derives its name from archaic models of magnetism,
whose proponents believed in the literal flow of a magnetic fluid
called the `luminiferous æther'. Nowadays, scientists tend toward more
modern interpretations using electromagnetic fields involving quantum
theory. Nonetheless, the name sticks. Magnetic flux, $\flux$, is
therefore defined as the amount of `magnetic fluid' passing through an area:
\begin{dmath}
  \flux = \magB \cdot \vecarea
\end{dmath}
This flux is almost analogous to electric current; the only difference
being that electric current is constrained by the conductor it is
flowing through, whereas while magnetic flux is known to \emph{prefer}
areas of greater permeability, it occasionally can deviate from these simple paths.

\begin{figure}
\includegraphics{PhD/Figures/Magnets/magflux}
\caption{Lines of magnetic flux of a single magnet.}
\figlabel{magflux}
\end{figure}

An analysis of how to derive the paths of magnetic flux is a beyond the scope of this document, but it is important to discuss the flux lines themselves.
Typical flux lines for a rectangular cross-section magnet are shown in \figref{magflux}.
It is more instructive for a basic understanding of how magnets behave to examine the ways their flux lines interact.
The following `magnet
design axioms' are adapted from \textcite{moskowitz1995}, whose book
covers permanent magnet design for a wide range of uses.
\begin{enumerate}
\item Flux lines follow the path of least resistance. This means that they will
travel through the shortest path possible,
through the material with the
\emph{greatest} permeability---so they will travel more readily through
magnetic or ferrous material than air, and more readily through air
(although only slightly) than diamagnetic material.
\item Flux lines travelling in the same direction repel each other. This means
flux lines will never cross.
\item Flux lines enter ferrous material at right angles in a low-permeability surrounding.
\item Permeability of ferrous material is `used up' by flowing flux; when the
material reaches saturation, flux lines travel as easily though air as through
the saturated material.
\item Flux lines travel from North to South poles in closed loops.
\item Magnets are made up of a very large number of unit poles.
\end{enumerate}
From these axioms, one can generate incorrect, yet applicable,
theories how and why magnets attract and repel each other. For
example, two magnets in repulsion have flux lines opposing each
other.
It can be imagined that the reason forces occur between them is
due to a `squashing' of the flux lines which the magnets try to
oppose---but theories like this only help visualising magnetic
behaviour, \emph{not} for explaining the reasons behind it.
\note{Just ask \textcite{sodano2006}, who received nitpicking comments about their terminology \cite{marneffe2007}.}

\section{Permanent magnets and magnetic materials}

There are several materials from which permanent magnets can be
made. Short attention will be placed on the cheaper, legacy magnetic
materials such as the ferrite magnets and alnico magnets due to their
poor performance. Rare-earth neodymium magnets are now readily
available and rather inexpensive, and have much more desirable properties
than these old fashioned magnets.

\Tabref{magnets} shows some approximate ranges comparing the
properties of the various magnet types available. Clearly, rare earth
magnets are capable of much greater energy output, and their high
coercivity precludes them from losing their magnetisation through
physical impact or proximity with other magnets---unlike the older
ferrite and alnico magnets.
Their main disadvantage is their low maximum operating temperatures, which could be inconvenient when using them for biased, or hybrid, electromagnets, in which a current carrying coil is wrapped around a permanent magnet to increase the output of the magnetic field.

\begin{table}
  \caption[Typical values for various permanent magnets.]
  {Typical values for various permanent magnets.
   Adapted from information from \url{http://www.magtech.com.hk/}.}
  \tablabel{magnets}
  \begin{tabular}{@{} l r@{\,--\,}l r@{\,--\,}l r@{\,--\,}l @{}}
    \toprule
    & \multicolumn{6}{c@{}}{Magnet type}\\
    \cmidrule(l){2-7}
    Property            & \multicolumn{2}{c@{}}{Ferrite}
                        & \multicolumn{2}{c@{}}{Alnico}
                        & \multicolumn{2}{c@{}}{Neodymium}  \\
    \midrule
    Max.\ temperature (°C)    & \num{400} & \num{500} & \num{800} & \num{900} &    \num{ 80} & \num{200}  \\
    Remanence (T)             & \num{0.2} & \num{0.4} & \num{0.5} & \num{1.3} &    \num{  1} & \num{1.3}  \\
    Coercivity (\si{kA/m})    & \num{100} & \num{200} & \num{50 } & \num{160} & ~~~\num{800} & \num{900}  \\
    Max.\ energy product
               (\si{kJ/m^3})  & \num{6}   & \num{33}  & \num{10}  & \num{80}  &    \num{200} & \num{300}  \\
    \bottomrule
  \end{tabular}
\end{table}


\section{General technieques for calculating forces between magnets}
\seclabel{magnet-forces}

A general technique for finding the forces between two magnets is
simple to describe. The first magnet creates a magnetic field in the
region of the second magnet; the force is calculated due to the
interaction of the first magnet's field and the internal field of the
second magnet. Or vice versa; reciprocity holds here.

There are two methods that will be outlined here for calculating the magnetic field of a permanent magnet, known as the charge and current models.
Respectively, these consist of modelling the magnets as having two surfaces of `magnetic charge', or modelling the magnet as being circumscribed of an equivalent surface current density.
In the expressions to follow, the magnetisation of each magnet has been assumed to be homogeneous and constant, which is usually a reasonable assumption for modern rare earth magnetic material; hence terms involving $\Div\magM$ and $\Curl\magM$ equate to zero.

In the first step, the integration takes place over the surface of the
first magnet $\surface_1$, which is written for the charge model as
\begin{dmath}
\magB_1\fn{\pos_2} =
 \magconst\oint\limits_{\surface_1}
    \gp{\magM_1\dotprod\normn_{\diffsurface_1}}
    \frac{\pos_2-\pos_1}{\Abs{\pos_2-\pos_1}^3}
    \dee \diffsurface_1
\end{dmath},
and for the current model as
\begin{dmath}
\magB_1\fn{\pos_2} =
 \magconst\oint\limits_{\surface_1}
    \gp{\magM_1\cross\normn_{\diffsurface_1'}}\cross
    \frac{\pos_2-\pos_1}{\Abs{\pos_2-\pos_1}^3}
    \dee \diffsurface_1'
\end{dmath},
where $\normn$ is the normal vector from the differential surface of integration $\dee\diffsurface$.

In the second step, the integration of the function of the magnetic field of the first magnet takes place over the surface of the second magnet $S_2$, and the integral for the charge model is
\begin{dmath}[label=charge-force]
\force = \oint\limits_{\surface_2}
  \gp{\magM_2\dotprod\normn_{\diffsurface_2}} \magB_1\fn{\pos_2} \dee \diffsurface_2
\end{dmath},
and for the current model is
\begin{dmath}[label=current-force]
\force = \oint\limits_{\surface_2}
  \gp{\magM_2\cross\normn_{\diffsurface_2'}} \cross \magB_1\fn{\pos_2} \dee \diffsurface_2'
\end{dmath}.

\Eqref{charge-force,current-force} are general recipes for deriving equations to calculate the forces between permanent magnets, and a similar formulation will allow for the modelling of electromagnetic coils as well.
A comparison between the current and charge models for calculating the magnetic field for radially-magnetised arc-shaped magnets was made by \textcite{ravaud2009-pier-compare}, who stated:
\begin{quote}
The problem is thus to guess what model is the most appropriate for calculating the three components of the magnetic field produced by permanent magnets.
It does not seem to be more difficult to use the Amperian current model rather than the Coulombian [`charge'] model for calculating the magnetic field created by parallelepiped magnets. [\dots] For arc-shaped permanent magnets, it seems to be more difficult to guess what model is the most appropriate.
\end{quote}
One important consideration to bear in mind for deriving force equations is that charge model precludes having overlap between the two volumes, such as when a magnet slides within an outer coil.
As an example, the theory of \textcite{akoun1984} for calculating the force between two cuboid permanent magnets was derived by modelling each magnet using the charge model; whereas \textcite{rovers2010-ietm} used the current model for calculating the force between a rectangular cross section coil and a permanent magnet.
Since a permanent magnet can be modelled as a thin coil, the two expressions can be compared and they only give equivalent results when the two volumes do not overlap.

\Eqref{charge-force,current-force} cannot be solved analytically for complex geometries as the integrals become intractable; numerical integration must be used in this case \cite{charpentier2001-compel}.
When this is necessary, the integrals are generally simplified as much as possible before numerical integration is applied to the remaining terms; for this reason this technique is often called a `semi-numerical' approach, and is capable of obtaining results in a more straightforward and efficient manner than finite element analysis.

An alternative method to the numerical integration approach is proposed by \textcite{furlani2001-magnetbook} in which a magnetic source is discretised into a large number of `point charges' and the analytical expression for force between each pair combination summed through superposition.
In this case, a general equation for calculating the force between two magnets using the surface charge method can be written as: \cite{furlani1993-ietm}
\begin{dmath}
\force = \frac{\remanence^2\permvac}{2\pi}
  \sum_{\area_2}\gp{\sum_{\area_1}\gp{
    \frac{\pos_2-\pos_1}{\Abs{\pos_2-\pos_1}^3}
  }\Delta \area_1}\Delta \area_2
\end{dmath},
where $\area_1$ and $\area_2$ are the areas of surface charge in the two magnets, and $\pos_1$ and $\pos_2$ are the position vectors of each surface charge in the interactive pair.
While this method does allow the modelling of arbitrary geometries, care must be taken to use a fine enough discretisation mesh to achieve convergence of the solution, and as the mesh becomes finer the algorithm increases in solution time at a rate approximately square to the number of point charges in the model.
This discretisation method is avoided in this thesis due to the limited advantage it has over using the semi-numerical approach that uses numerical integration directly.


\section{Analytical expressions for calculating the magnetic flux density}

For the purposes of this work, the analytical calculation of the magnetic flux $\magB$ is largely overlooked in favour of analytical force calculations, which will be dealt with in the next section.
However, since an analytical formulation for $\magB$ is a requirement for then calculating the force, a short literature review will be covered here for different magnet geometries.

The magnetic field for cuboid shaped magnets has a concise solution and has been known for some time for magnetisation in a direction orthogonal to the magnet face \cite{akoun1984}.
Much more recently, expressions were presented for calculating the magnetic field from a cuboid magnet with magnetisation in an arbitrary direction \cite{ravaud2009-pier98}.

Expressions for calculating the magnetic field due to magnetic prisms with triangular faces \cite{compter2010-ietm,janssen2010-compel,rubeck2013-ietm} can be used using superposition to find the magnetic field from magnets with the shape of a quadrilateral pyramidal frustrum, which is a six-sided solid with two parallel faces and four non-orthogonal faces.
Such magnet shapes can be stacked to form efficient planar multipole arrays \cite{janssen2009-ietm} (see also \chapref[vref]{multipole}).

The geometry of cylindrical magnets and coils results in elliptic integrals in the solution to their field equations.
For a cylindrical magnet, the field solutions have been published for both axial magnetisation \cite{ravaud2010-ietm} and radial magnetisation \cite{furlani1995-ietm}.
It is interesting from a historical perspective that new publications on the analytic magnetic field equation for a `thick coil' (or toroidal conductor with rectangular cross section, more precisely) appear to be being published at an accelerating rate \cite{danilov1971-nim,urankar1982-ietm,babic1988-ietm,azzerboni1993-ietm,labinac2006-ajp,pechenkov2006-rndt,ravaud2010-emwaves,zhang2012-ietm}.
The newer equations tend to be more general and/or robust.



\section{Forces between parallel cuboid magnets}
\seclabel{cuboid}

In this section, the literature for forces between cuboid magnets is introduced in detail as this theory is used extensively in this work.
The theory for combining the force equations between parallel and orthogonal cuboid magnets is formalised for the purpose of calculating the forces between arbitrarily magnetised cuboid magnets.

\subsection{(Anti-)parallel alignment}

\def\e#1{e_#1}

A variety of analytical solutions have been developed to calculate the
force between cuboid-shaped magnets with parallel/anti-parallel
magnetisations \cite{akoun1984,nagaraj1988,bonisoli2006}. More complex
geometries can be realised through superposition of the solutions
\cite{bancel1999}.

\begin{figure}
  \asyinclude{PhD/Figures/Magnets/akoun}
  \caption
  [Geometry for parallel cuboid magnets.]
  {Geometry for the expression by \textcite{akoun1984} to
  calculate the forces between two parallel cuboid magnets with
  magnetisations in the vertical direction, distance between their centres
  $\magcd=\inlinevect{\cdx,\cdy,\cdz}\T$, and magnet sizes as shown.}
  \figlabel{akoun}
\end{figure}

The notation for the models to calculate the forces between cuboid magnets is as follows, with the geometry of the system depicted graphically in \figref{akoun}.
The first magnet has dimensions $\inlinevect{2\hwxX, 2\hwyX, 2\hwzX}\T$ and the second magnet has dimensions $[2\hwxF, 2\hwyF, 2\hwzF]\T$.
The distance between their centres is given by $\magcd=\inlinevect{\cdx,\cdy,\cdz}\T$.
The force calculated is that acting on the second magnet; for this reason the first magnet is sometimes refered to as the `fixed' magnet and the second the `floating' one.
The magnetisations of the magnets are assumed to be constant and aligned in the $\az$ direction (`facing up').
Anti-parallel magnets (`negative magnetisation') corresponds to the secondary magnet `facing down' and results in forces of reversed sign.
 \note{This relationship is only true of high-coercivity magnets; for magnets such as ferrites whose own magnetic fields can demagnetise each other, an approximation can be made that the repulsive force between two magnets will be approximately 40\% of the attractive force between them \cite{moskowitz1995}.}

The forces between two $\Fzz$ parallel or anti-parallel magnets with remanences $\magn1$ and $\magn2$ and geometry defined previously is compactly written as six nested summations of intermediate expressions in $\ax$, $\ay$, and $\az$ directions:
\begin{equation}\eqlabel{akoun}
\Fzz = \frac{\magn1\magn2}{4\pi\permVac}
  \sum_{i,j,k,l,p,q\in\{0,1\}^6}
  \hspace{-5mm}% space hack
  \Fzznode\fn{\cornerd_{i,j,k,l,p,q}}
  \cdot
  \gp{-1}^{i+j+k+l+p+q} ,
\end{equation}
where $\Fzznode\fn{\cornerd} = \inlinevect{\phi_x\fn{\cornerd},\phi_y\fn{\cornerd},\phi_z\fn{\cornerd}}\T$ will be given later.
The $(z,z)$ subscript refers to the directions of magnetisation of the magnets.
Force calculations for magnets oriented in the $\ax$ or $\ay$ directions can be found using a coordinate system transformation on \eqref{akoun}.

This form of \eqref{akoun} arises as it is derived from six nested direct integrals.
Rather than expanding the limits of each integral, the following summation notation is used instead; say $f$ integrates to $F$:
\begin{equation}
\Int {f\fn{x}}{x,-a,a} = F\fn{a}-F\fn{-a} =
\!\!\! % space hack
\sum_{i\in\{0,1\}} F\fn{a\gp{-1}^i}\cdot \gp{-1}^i  =
\!\!\! % space hack
\sum_{e_i\in\{1,-1\}}
\!\!\! % space hack
F\fn{a e_i}\cdot e_i .
\end{equation}
For multiple integrations the summation becomes
\begin{dmath}
\Int{ f\fn{x,y,z} } {x,x_0,x_1} {y,y_0,y_1} {z,z_0,z_1}=
  \sum_{i,j,k\in\{0,1\}^3} F\fn{x_i,y_j,z_k}\cdot\gp{-1}^{i+j+k}
\end{dmath}.
For $N$ nested integrals, it may be convenient to express this in a product form instead, where $f$ is integrated over variables $x_i$ from $u_i\fn{1}$ to $u_i\fn{-1}$:
\begin{dmath}
\Int{ f\fn{x_1,x_2,\dots} }{x_1}{x_2} \cdots =
  \sum_{e_1,e_2,\dots\in\{1,-1\}^N}
    \gp{ F\fn{u_1\fn{e_1},u_2\fn{e_2},\dots}\prod_{n=1}^{N} e_n }
\end{dmath}

As the limits of the integral occur at the corners of the cuboid magnets, $\Fzznode$ is an intermediate function acting between each combination of corners between the first and second magnet.
Bancel \cite{bancel1999} used this fact to invent an abstraction for these expressions known as `magnetic nodes' calling the term $\Fzznode\fn{\cornerd_{i,j,k,l,p,q}}\cdot\gp{-1}^{i+j+k+l+p+q}$ in \eqref{akoun} the `force' between two magnetic nodes $(i,k,p)$ and $(j,l,q)$.
Summing the magnetic node forces between every combination of corners of the first and second magnet yields the total force between them.
This abstraction allows a reduction in the number of calculations required when magnetic nodes overlap; \ie, when calculating the forces between arrays of touching magnets.

The distance between two corners/nodes of two respective magnets, $\cornerd_{i,j,k,l,p,q}=[\cnrx_{i,j}, \cnry_{k,l}, \cnrz_{p,q}]\T$, is given by the distance between the magnet centres, $\magcd=\inlinevect{\cdx,\cdy,\cdz}\T$, minus and plus the distance between the magnet centre and corner position for the fixed magnet, $\cdcnrX$, and for the floating magnet, $\cdcnrF$, \resp:
\begin{dmath}
\cornerd_{i,j,k,l,p,q}=\magcd - \cdcnrX_{i,k,p} + \cdcnrF_{j,l,q}
\end{dmath},
where
\begin{align}
\cdcnrX_{i,k,p}&=\begin{bmatrix}\hwxX\gp{-1}^i\\\hwyX\gp{-1}^k\\\hwzX\gp{-1}^p\end{bmatrix},&
\cdcnrF_{j,l,q}&=\begin{bmatrix}\hwxF\gp{-1}^j\\\hwyF\gp{-1}^l\\\hwzF\gp{-1}^q\end{bmatrix}.
\end{align}
Complete expressions for the corner distances are therefore:
\begin{dmath}[compact]
\cornerd_{i,j,k,l,p,q}=\begin{bmatrix}\cnrx_{i,j}\\\cnry_{k,l}\\\cnrz_{p,q}\end{bmatrix}=
\begin{bmatrix}
  \cdx-\hwxX\gp{-1}^i+\hwxF\gp{-1}^j\\
  \cdy-\hwyX\gp{-1}^k+\hwyF\gp{-1}^l\\
  \cdz-\hwzX\gp{-1}^p+\hwzF\gp{-1}^q
\end{bmatrix}
\end{dmath}.
The $\Fzznode$ terms required for calculating the `force between nodes' can now be written, where $\cnrl=\sqrt{\cnrx^2+\cnry^2+\cnrz^2}$, as:
\begin{dmath}[label=phi-zz]
\Fzznode\fn{\cornerd} =
\begin{bmatrix}
\half\gp{\cnry^2-\cnrz^2}\Log{\cnrl-\cnrx}+\cnrx\cnry\Log{\cnrl-\cnry}+\cnry \cnrz\ArcTan{\tfrac{\cnrx \cnry}{\cnrl\cnrz}}+\half \cnrl\cnrx \\
\half\gp{\cnrx^2-\cnrz^2}\Log{\cnrl-\cnry}+\cnrx\cnry\Log{\cnrl-\cnrx}+\cnrx\cnrz\ArcTan{\tfrac{\cnrx \cnry}{\cnrl\cnrz}}+\half \cnrl\cnry \\
-\cnrx\cnrz\Log{\cnrl-\cnrx}-\cnry \cnrz\Log{\cnrl-\cnry}+\cnrx \cnry\ArcTan{\tfrac{\cnrx \cnry}{\cnrl\cnrz}}-\cnrl\cnrz
\end{bmatrix}
\end{dmath}
Note that when evaluating these functions, two numerical singularities must be accounted for:
\begin{align}
\lim_{x\to 0} x \log x &= 0 , & \lim_{x\to 0} \arctan(x/x) &= 0.
\end{align}

The stiffness characteristics can be derived by differentiating \eqref{akoun} with respect to displacement in each respective direction, resulting in
\begin{dmath}[label=akounk]
\Kzz = \frac{\magn1\magn2}{4\pi\permVac} \sum_{(i,j,k,l,p,q)\in\{0,1\}^6} \Kzznode\fn{\cnrx_{ij},\cnry_{kl},\cnrz_{pq},\cnrl}
\cdot \gp{-1}^{i+j+k+l+p+q} ,
\end{dmath}
where
\begin{dmath}
\Kzznode =
\begin{bmatrix}
-\frac{\cnry \cnrx^2}{\cnrx^2+\cnrz^2}-\cnrl-\cnry \Log{\cnrl-\cnry} \\
-\frac{\cnrx \cnry^2}{\cnry^2+\cnrz^2}-\cnrl-\cnrx \Log{\cnrl-\cnrx} \\
 \frac{\cnry \cnrz^2}{\cnrx^2+\cnrz^2}
  + \frac{\cnrx \cnrz^2}{\cnry^2+\cnrz^2}
  + 2\cnrl+\cnrx\Log{\cnrl-\cnrx}+\cnry \Log{\cnrl-\cnry}
\end{bmatrix}
\end{dmath}
Note that the sum of the stiffness components ${\Kzz}_x+{\Kzz}_y+{\Kzz}_z=0$ follows from Earnshaw's theorem \cite{earnshaw1842} following from the solution to Laplace's equation.





\subsection{Forces between orthogonal cuboid magnets}

Two groups of researchers simultaneously published, in the same journal, equivalent methods to calculate the force between orthogonal cuboid magnets \cite{janssen2009-sensorletters,allag2009-sensorletters}.
The expressions of \textcite{allag2009-sensorletters} are slightly simpler and are reproduced here for completeness and consistency.
The signs of their equations have been reversed for consistency with \eqref{akoun} in which the equations calculate the force on the second magnet.

The force on a magnet magnetised in the $\ay$ direction due to its interaction with a magnet magnetised in the $\az$ direction is \parencite{allag2009-sensorletters}
\begin{dmath}[label=orth-magforce]
\Fzy = \frac{\magn1\magn2}{4\pi\permVac} \sum_{i,j,k,l,p,q\in\{0,1\}^6} \Fzynode\fn{\bm \delta}\cdot\gp{-1}^{i+j+k+l+p+q}
\end{dmath}
Again, the distance between the `corner nodes' of each magnet is given by
\begin{dmath}
\cornerd_{i,j,k,l,p,q}=\magcd+\cdcnrF_{j,l,q} - \cdcnrX_{i,k,p}
\end{dmath},
where
\begin{align}
\cdcnrF_{j,l,q}&=\begin{bmatrix}\hwxF\gp{-1}^j\\\hwyF\gp{-1}^l\\\hwzF\gp{-1}^q\end{bmatrix},&
\cdcnrX_{i,k,p}&=\begin{bmatrix}\hwxX\gp{-1}^i\\\hwyX\gp{-1}^k\\\hwzX\gp{-1}^p\end{bmatrix},
\end{align}
with magnet dimensions defined as earlier.
The $\Fzynode$ terms required for calculating the `force between nodes' for orthogonal magnets are
\begin{align}
\begin{split}
{\Fzynode}_x\fn{\cornerd} &= \cnry\cnrz\Log{\cnrl-\cnrx}-\cnrx\cnry\Log{\cnrl+\cnrz}-\cnrx\cnrz\Log{\cnrl+\cnry}+\\&\qquad\half \cnrx^2\ArcTan{\frac{\cnry\cnrz}{\cnrl\cnrx}}+\half \cnry^2\ArcTan{\frac{\cnrx\cnrz}{\cnrl\cnry}}+\half \cnrz^2\ArcTan{\frac{\cnrx\cnry}{\cnrl\cnrz}} \,,\\
{\Fzynode}_y\fn{\cornerd} &= -\half\gp{\cnrx^2-\cnry^2}\Log{\cnrl+\cnrz}+\cnrx\cnrz\Log{\cnrl-\cnrx}+\cnrx\cnry\arctan\fn{\tfrac{\cnrx\cnrz}{\cnrl\cnry}}+\half \cnrl\cnrz \,,\\
{\Fzynode}_z\fn{\cornerd} &= -\half\gp{\cnrx^2-\cnrz^2}\Log{\cnrl+\cnry}+\cnrx\cnry\Log{\cnrl-\cnrx}+\cnrx\cnrz\arctan\fn{\tfrac{\cnrx\cnrz}{\cnrl\cnry}}+\half \cnrl\cnry \,.
\end{split}
\end{align}



\subsection{Simplified force and stiffness expression for cube magnets}
\seclabel{cube-forces}

The function $\magforce$ is the simplication of the force between parallel magnets\eqref{akoun} for equal cube-shaped magnets, where $\mdim$ is the side length, $\ndisp=\gamma/\mdim$ is the normalised vertical displacement, and $\magn1$ and $\magn2$ are the remanence magnetisations of the two magnets:
\begin{dmath}[label=magforce]
\magforce = \mdim^2 \nforce
\end{dmath},
where
\begin{dmath}[label=nforce]
  \nforce = \frac{\magn1\magn2}{\pi\permVac} \bar{\nforce}
\end{dmath},
and
\begin{footnotesize}
\begin{dmath}
  \bar{\nforce} = \gp{-2+\ndisp}\cdot\Abs{-2+\ndisp}-2 \ndisp \Abs{\ndisp}+\gp{2+\ndisp}\cdot
  \Abs{2+\ndisp}+4 \ndisp \sqrt{4+\ndisp^2}
  -2 \ndisp \sqrt{8+\ndisp^2}+\gp{4-2 \ndisp} \sqrt{8-4
    \ndisp+\ndisp^2}+\gp{-2+\ndisp} \sqrt{12-4 \ndisp+\ndisp^2}
  +\gp{-4-2 \ndisp} \sqrt{8+4 \ndisp+\ndisp^2}+\gp{2+\ndisp}
  \sqrt{12+4 \ndisp+\ndisp^2}
  +2 \left[ 4 \mathatan\left[\frac{4}{\ndisp \sqrt{8+\ndisp^2}}\right]+2
    \mathatan\left[\frac{4}{\gp{2-\ndisp}
        \sqrt{12-4 \ndisp+\ndisp^2}}\right]\right.
  -2 \mathatan\left[\frac{4}{\gp{2+\ndisp} \sqrt{12+4 \ndisp+\ndisp^2}}\right]+2 \ndisp
  \mathlog\left[-2+\sqrt{4+\ndisp^2}\right]
  -2 \ndisp \mathlog\left[2+\sqrt{4+\ndisp^2}\right]-2 \ndisp
  \mathlog\left[-2+\sqrt{8+\ndisp^2}\right]
  +2 \ndisp \mathlog\left[2+\sqrt{8+\ndisp^2}\right]+2
  \mathlog\left[-2+\sqrt{8-4
      \ndisp+\ndisp^2}\right]
  -\ndisp \mathlog\left[-2+\sqrt{8-4 \ndisp+\ndisp^2}\right]-2
  \mathlog\left[2+\sqrt{8-4 \ndisp+\ndisp^2}\right]
  +\ndisp \mathlog\left[2+\sqrt{8-4 \ndisp+\ndisp^2}\right]-2
  \mathlog\left[-2+\sqrt{12-4 \ndisp+\ndisp^2}\right]
  +\ndisp \mathlog\left[-2+\sqrt{12-4 \ndisp+\ndisp^2}\right]+2
  \mathlog\left[2+\sqrt{12-4 \ndisp+\ndisp^2}\right]
  -\ndisp \mathlog\left[2+\sqrt{12-4 \ndisp+\ndisp^2}\right]-2
  \mathlog\left[-2+\sqrt{8+4 \ndisp+\ndisp^2}\right]
  -\ndisp \mathlog\left[-2+\sqrt{8+4 \ndisp+\ndisp^2}\right]+2
  \mathlog\left[2+\sqrt{8+4 \ndisp+\ndisp^2}\right]
  +\ndisp \mathlog\left[2+\sqrt{8+4 \ndisp+\ndisp^2}\right]+2
  \mathlog\left[-2+\sqrt{12+4 \ndisp+\ndisp^2}\right]
  +\ndisp \mathlog\left[-2+\sqrt{12+4 \ndisp+\ndisp^2}\right]-2
  \mathlog\left[2+\sqrt{12+4 \ndisp+\ndisp^2}\right]
  \left.  -\ndisp \mathlog\left[2+\sqrt{12+4 \ndisp+\ndisp^2}\right]\right]
\end{dmath}
\end{footnotesize}

The stiffness $\magstiffness$ is calculated by differentiating \eqref{akoun} before simplifying, as with the force terms, to
\begin{dmath}[label=magstiffness]
\magstiffness = \mdim \nstiffness
\end{dmath},
where
\begin{dmath}[label=nstiffness]
  \nstiffness = -\frac{2\magn1\magn2}{\pi\permVac} \bar\nstiffness
\end{dmath},
and
\begin{footnotesize}
\begin{dmath}
  \bar\nstiffness = \Abs{-2+\ndisp}-2 \Abs{\ndisp}+\Abs{2+\ndisp}+4
  \sqrt{4+\ndisp^2}-2\sqrt{8+\ndisp^2}
  -2 \sqrt{8-4 \ndisp+\ndisp^2}+\sqrt{12-4 \ndisp+\ndisp^2}-2 \sqrt{8+4\ndisp+\ndisp^2}
  +\sqrt{12+4 \ndisp+\ndisp^2}+2 \mathlog\left[-2+\sqrt{4+\ndisp^2}\right]
  -2\mathlog\left[2+\sqrt{4+\ndisp^2}\right]
  -2\mathlog\left[-2+\sqrt{8+\ndisp^2}\right]
  +2\mathlog\left[2+\sqrt{8+\ndisp^2}\right]
  -\mathlog\left[-2+\sqrt{8-4 \ndisp+\ndisp^2}\right]
  +\mathlog\left[2+\sqrt{8-4\ndisp+\ndisp^2}\right]
  +\mathlog\left[-2+\sqrt{12-4\ndisp+\ndisp^2}\right]
  -\mathlog\left[2+\sqrt{12-4\ndisp+\ndisp^2}\right]
  -\mathlog\left[-2+\sqrt{8+4 \ndisp+\ndisp^2}\right]
  +\mathlog\left[2+\sqrt{8+4\ndisp+\ndisp^2}\right]
  +\mathlog\left[-2+\sqrt{12+4\ndisp+\ndisp^2}\right]
  -\mathlog\left[2+\sqrt{12+4 \ndisp+\ndisp^2}\right]
\end{dmath}
\end{footnotesize}

These simplified equations are reproduced here to emphasise the $\mdim^2$ relationship for the force shown in \eqref{magforce} and the $\mdim$ relationship for the stiffness in \eqref{magstiffness}.
This is interesting because it is not evident from Akoun~and Yonnet's original equations that such a simplification is possible.

\subsection{Cuboid magnets with arbitary magnetisations}
\seclabel{magforce-arbitary}

Most force expressions are derived from magnetic field equations that are assumed for magnets with magnetisation parallel to one of their sides.
Superposition can then be used to combine the expressions for orthogonal magnets to generate the force from a magnet with arbitrary magnetisation.
\textcite{ravaud2009-pier98} instead show the magnetic field equations for a cuboid magnet with arbitrary magnetisation; their work is still to be extended to calculate the forces between such magnets.
Since their equation for calculating the magnetic field is necessarily more complex, it is not clear whether an equation derived using analytical integration to calculate the force directly (if the integral is even tractable) will be more efficient than the superposition approach outlined in the following.

The geometry of the two-magnet system is shown in \figref{akoun}, in which the magnets have sides of length $\mwX = [2\hwxX, 2\hwyX, 2\hwzX]\T$ and $\mwF = [2\hwxF, 2\hwyF, 2\hwzF]\T$ respectively and the distance between their centres is given by $\magcd=[\cdx,\cdy,\cdz]\T$. The calculations always assume that the first magnet is fixed and force is acting on the second magnet. The signs must be reversed to obtain the forces acting on the first magnet.

As shown earlier in \eqref{akoun},
\textcite{akoun1984} provide the force expressions for magnets with vertical magnetisations.
This force is now denoted $\Fzz\fn{\mwX, \mwF, \magcd, \magn1, \magn2}$ as a function of the magnet sizes, the distance between them, and their magnetisation magnitudes $\magn1$ and $\magn2$.
From \eqref{orth-magforce}, \textcite{allag2009-electromotion} provide the force expressions for the first magnet with vertical magnetisation and the second magnet with magnetisation in the horizontal $\ay$ direction.
This force is denoted $\Fzy\fn{\mwX, \mwF, \magcd, \magn1, \magn2}$.

The force between a vertically-magnetised magnet and one with magnetisation in the horizontal $\ax$ direction can be calculated by applying a rotational transformation to $\Fzy$ around the $\az$ axis.
That is,
\begin{equation}\eqlabel{fzx}
\Fzx\fn{\mwX,\mwF, \magcd, \magn1, \magn2} = \rotZ\fn{-\tfrac{\pi}2}\Fzx\fn{\mwX_{z,x}, \mwF_{z,x},\magcd_{z,x}, \magn1, \magn2} ,
\end{equation}
where
\begin{align}
\mwX_{z,x} &= \Abs{\rotZ\fn{\tfrac\pi2}\mwX}, \\
\mwF_{z,x} &= \Abs{\rotZ\fn{\tfrac\pi2}\mwF}, \\
\magcd_{z,x} &= \rotZ\fn{\tfrac\pi2}\magcd,
\end{align}
for which $\Abs{\cdot}$ is the \emph{element-wise} absolute value function and $\rotZ\fn{\theta}$ is the rotation matrix around the $\az$ axis:
\begin{equation}\eqlabel{rotZ}
\rotZ\fn\theta = \begin{bmatrix}
\cos\theta & -\sin\theta & 0 \\
\sin\theta & \hphantom{-{}}\cos\theta & 0 \\
0 & 0 & 1
\end{bmatrix}.
\end{equation}

Using the force expressions $\Fzx$, $\Fzy$, and $\Fzz$ in superposition allows the force to be calculated between a vertically magnetised magnet and another magnet with arbitrary magnetisation direction. By applying coordinate system transformations to these expressions, arbitrary magnetisation directions can be achieved for the first magnet as well.

For horizontal $\ax$ direction magnetisation,
\begin{equation}\eqlabel{fxxyz}
\vect F_{x,\{x,y,z\}}\fn{\mwX, \mwF, \magcd, \magn1, \magn2} =
  \rotY\fn{\tfrac\pi2}
  \vect F_{z,\{z,y,x\}}\fn{\mwX_x, \mwF_x, \magcd_x, \magn1, \magn2}
\end{equation}
where
\begin{align}
\mwX_x &= \Abs{\rotY\fn{-\tfrac\pi2}\mwX}, &
\mwF_x &= \Abs{\rotY\fn{-\tfrac\pi2}\mwF}, &
\magcd_x &= \rotY\fn{-\tfrac\pi2}\magcd,
\end{align}
and $\rotY\fn{\theta}$ is the rotation matrix around the $\ay$ axis:
\begin{equation}
\rotY\fn\theta = \begin{bmatrix}
\cos\theta & 0 & -\sin\theta \\
0 & 1 & 0 \\
\sin\theta & 0 & \hphantom{-{}}\cos\theta \\
\end{bmatrix}.
\end{equation}
Similarly, for horizontal $\ay$ direction magnetisation,
\begin{equation}\eqlabel{fyxyz}
\vect F_{y,\{x,y,z\}}\fn{\mwX, \mwF, \magcd, \magn1, \magn2} = \\
  \rotX\fn{-\tfrac\pi2}
  \vect F_{z,\{x,z,y\}}\fn{\mwX_y, \mwF_y, \magcd_y, \magn1, \magn2}
\end{equation}
where
\begin{align}
\mwX_y &= \Abs{\rotX\fn{\tfrac\pi2}\mwX}, &
\mwF_y &= \Abs{\rotX\fn{\tfrac\pi2}\mwF}, &
\magcd_y &= \rotX\fn{\tfrac\pi2}\magcd,
\end{align}
and $\rotX\fn{\theta}$ is the rotation matrix around the $\ax$ axis:
\begin{equation}
\rotX\fn\theta = \begin{bmatrix}
1 & 0 & 0 \\
0 & \cos\theta & -\sin\theta \\
0 & \sin\theta & \hphantom{-{}}\cos\theta \\
\end{bmatrix}.
\end{equation}

Given the results of the afore-referenced papers by Yonnet et al.\ and \eqref{fzx,fxxyz,fyxyz}, the force between two magnets of arbitrary magnetisation can be written as
\begin{equation}\eqlabel{total-force}
\vect F\fn{\mwX, \mwF, \magcd,\expandafter\vect \magn1,\expandafter\vect \magn2}=\sum_{i,j\in\{x,y,z\}^2} \vect F_{i,j}\fn{\mwX, \mwF, \magcd, J_{1_i}, J_{2_j}}
\end{equation}
where
\begin{align}
\expandafter\vect \magn1 &= [J_{1_x},J_{1_y},J_{1_z}]\T, &
\expandafter\vect \magn2 &= [J_{2_x},J_{2_y},J_{2_z}]\T.
\end{align}
Although it is well known that the principle of superposition can be used in this way,
this is the first formalisation of this theory to decompose a diagonal magnetisation into its orthogonal components for calculating the forces between diagonally-polarised magnets.




\subsection{Forces between magnets with relative rotation}
\seclabel{french-equations}

In 1999, a number of papers were published by researchers at \emph{Laboratoire
d'Electrotechnique et de Magnétisme de Brest} investigating the forces between
non-contact magnetic rotational force couplings.
These are of interest to this
work because they use an analytical expression for the forces between two
cuboidal magnets under arbitrary translation, with one inclined at any angle
around the $\ax$ axis.
A side-view schematic of this geometry is shown in \figref{magrot}.

\begin{figure}
  \asyinclude{\jobname/magrot.asy}
  \caption{Geometry for calculating the force between rotated magnets.}
  \figlabel{magrot}
\end{figure}


Three papers were published \cite{elies1998,charpentier1999-ietm-mar,charpentier1999-ietm-sep}
that all contain the force expression of interest, with a fourth \cite{elies1998} containing just the force expression in a single direction.
Their expressions are re-written here because each separate publication contains different typographical errors.
The equations here have been reconstructed by comparing the differences and similarities between the equations in the different papers, and re-written in a more compact form.
Given two magnets located in \threeD/ space, of sizes $\inlinevect{2\hwxX,2\hwyX,2\hwzX}$ and $\inlinevect{2\hwxF,2\hwyF,2\hwzF}$, with the plane of the second rotated by $\mrot$ around the $\ax$ axis and their centres separated by a distance $\inlinevect{\cdx,\cdy,\cdz}$, the forces in the $\ay$ and $\az$ directions ($\force{2}$ and $\force{3}$) between the two magnets can be calculated using the following equations:
\begin{dmath}
\force{2} = \frac{\magn1\magn2}{4\pi\permVac}
  \sum_{i_{\hwxX,\hwyX,\hwzX,\hwxF,\hwyF,\hwzF}\in\{0,1\}^6}
  f_{y_2}\cdot\gp{-1}^{i_\hwxX+i_\hwyX+i_\hwzX+i_\hwxF+i_\hwyF+i_\hwzF}
\end{dmath},
\begin{dmath}[label=charpz]
\force{3}\bigg|_{\mrot\neq k\pi} =
       \frac{-\magn1\magn2}{4\pi\permVac}\cdot\smash{\sum_{i_{\hwxX,\hwyX,\hwzX,\hwxF,\hwyF,\hwzF}\in\{0,1\}^6}}
        f_{z_2}\cdot\gp{-1}^{i_\hwxX+i_\hwyX+i_\hwzX+i_\hwxF+i_\hwyF+i_\hwzF}
\end{dmath},
\begin{dmath}
f_{y_2} = f_3\fn{u_0 , \cdy , \cdz , \mrot , \hwzX i_c , \hwzF i_C}
\end{dmath},
\begin{dmath}
f_{z_2} =  \frac{f_3\fn{u_1,v_1,w_1,-\mrot,0,0}}{\sin\mrot}
         + \frac{f_3\fn{u_2,v_2,w_2,\mrot,0,0}}{\tan\mrot}
\end{dmath},
\begin{dgroup}
\begin{dmath}
u_0 = \cdx - \hwxX i_a + \hwxF i_A
\end{dmath},
\begin{dmath}
u_1 = u_0-2\cdx
\end{dmath},
\begin{dmath}
v_1 = -v_2\cos\mrot - w_2\sin\mrot
\end{dmath},
\begin{dmath}
w_1 = v_2\sin\mrot - w_2\cos\mrot
\end{dmath},
\begin{dmath}
v_2 = \cdy-\hwzF i_C\sin\mrot
\end{dmath},
\begin{dmath}
w_2 = \cdz - \hwzX i_c + \hwzF i_C\cos\mrot
\end{dmath}.
\end{dgroup}
The following auxiliary function is used in the above. All dashed variables are
local to this function.
\begin{align}
\begin{split}
f_3\fn{u',v',w',\mrot',c',C'} &=
  u' f_5\gp{\Log{f_4-u'}-1}
  +\half\gp{f_6^2-{u'}^2}\Log{f_4+f_5} \\
  &\quad +\half u' \pi \Sign{f_5}\Abs{f_6}
  +u' f_6 \ArcTan{\frac{u' f_4 - {u'}^2 -f_6^2}{f_5 f_6}}
  +\half f_4 f_5 \,,
\end{split}\\
f_4 &= \sqrt{{u'}^2+f_5^2+f_6^2} \,, \\
f_5 &= \gp{v'-\hwyX i_b}\cos\mrot'+\gp{w'-c'}\sin\mrot'+2\hwyF i_B \,, \\
f_6 &= -\gp{v'-\hwyX i_b}\sin\mrot'+\gp{w'-c'}\cos\mrot'+C' \,.
\end{align}
For $\mrot=k\pi$, \eqref{akoun} of \textcite{akoun1984} should be used instead.

The force in the $\az$ direction is calculated separately if the second
magnet is not rotated around its axis ($f_{z_2}$ has a singularity
at $\mrot=k\pi$).
\begin{dgroup}
\begin{dmath}[label=Fz-pi]
\force{3}\bigg|_{\mrot=k\pi} =
  \cos\mrot\cdot\frac{-\magn1\magn2}{4\pi\permVac}
  \sum_{i_{a,b,c,A,B,C}\in\{0,1\}^6}f_{z_1}
  \cdot\gp{-1}^{i_a+i_b+i_c+i_A+i_B+i_C}
\end{dmath},
\begin{dmath}
f_{z_1} =
  \half uw\Log{\frac{r+u}{r-u}}+\half vw\Log{\frac{r+v}{r-v}}+
  uv\ArcTan{\frac{uv}{wr}-wr}
\end{dmath},
\begin{dmath}
u = x_0-ai_i+Ai_A
\end{dmath},
\begin{dmath}
v = y_0-bi_b+Bi_B+\half B\gp{\cos\mrot-1}
\end{dmath},
\begin{dmath}
w = z_0-ci_c+Ci_C+\half C\gp{\cos\mrot-1}
\end{dmath},
\begin{dmath}
r = \sqrt{u^2+v^2+w^2}
\end{dmath}.
\end{dgroup}
This equation is similar in form, but not identical, to Akoun~\& Yonnet's equation for the same, \eqref{akoun}.

In order to allow this equation to be used for rotations greater than \SI{\sipi}{radians}, additional terms have been added to accommodate for the translational offset induced by rotating the magnet around its lower-left edge.
This is necessary as the original equations used the lower-left corner of the magnet as its point of rotation, whereas the equations presented here use the magnet centre.
The preceding $\cos\mrot$ in \eqref{Fz-pi} provides the sign change of the magnetisation, and the $\half\gp{\cos\mrot-1}$ terms are used to return the origin of the magnet after 180\textdegree\ rotation to the lower-left corner, where it is expected.

Although these rotated-magnet force equations permit displacements in the $\ax$ direction, there is no published equation for calculating the component of force in this direction.
Numerical integration techniques are currently the best known method if this force must be calculated \cite{charpentier2001-compel}.

\subsubsection{Theoretical simulations}

As an example of using these equations to calculate forces as a function of magnet rotation, \figref{charp-rotate} shows the forces produced between two \SI{1}{T} \SI{10}{mm} cube magnets as a function of rotation angle $\mrot$ of the second magnet, with a \SI{20}{mm} offset between their centres.
Two cases are shown: in the first, the magnets are displaced vertically; in the second, the magnets are displaced horizontally.

\begin{figure}
  \begin{wide}
  \hspace{-0.8cm}%
  \begin{subfigure}
    \psfragfig{\phdpath Simulations/Theory/latex/charp-rotation-forces}
    \caption{\SI{20}{mm} vertical displacement.}
  \end{subfigure}
  \hfil
  \begin{subfigure}
    \psfragfig{\phdpath Simulations/Theory/latex/charp-horiz-rotation-forces}
    \caption{\SI{20}{mm} horizontal displacement.}
  \end{subfigure}
  \hfil
  \null
  \end{wide}
  \lofcaption{Vertical and horizontal forces on a rotating magnet
    due to a fixed magnet as a function of rotation angle for fixed horizontal and vertical displacements.}{ The two magnets are \SI{1}{T} \SI{10}{mm} cubes.}
  \figlabel{charp-rotate}
\end{figure}

\Figref{charp-rotate} shows that the maximum force between two magnets is exhibited when the direction of displacement is in the same direction as their magnetisations.
For displacements perpendicular to the direction of magnetisation of the fixed magnet, forces of equal magnitude are obtained for rotation of the second magnet $\mrot=k\pi/2$ for $k\in\{0,1,2,\dots\}$.

In the following simulations, the second magnet is held at a constant height (of a  separation distance of one magnet height) and moved from left to right over a range of twice the magnet width symmetrically above the first magnet (with respect to their centres of mass).
Four such displacements are made with four different rotations for the second magnet: $0$, $\half\pi$, $\pi$ and $-\half\pi$.
\Figref{charp-0to2pi} shows the forces in the horizontal $\ay$ direction and vertical $\az$ direction, \resp.
It can be seen that the opposite rotations result in symmetric force curves, as is expected.

\begin{figure}
  \begin{wide}
  \hspace{-1cm}%
  \begin{subfigure}
    \psfragfig{\phdpath Simulations/Theory/latex/charp-0to2pi-Fy}
    \caption{Horizontal forces.}
    \figlabel{charp-0to2pi-Fy}
  \end{subfigure}\qquad\hfil
  \begin{subfigure}
    \psfragfig{\phdpath Simulations/Theory/latex/charp-0to2pi-Fz}
    \caption{Vertical forces.}
    \figlabel{charp-0to2pi-Fz}
  \end{subfigure}
  \end{wide}
  \lofcaption{Vertical and horizontal forces on a rotating magnet situated \SI{20}{mm} above another and displaced horizontally for a range of magnet angles.}{ The two magnets are \SI{1}{T} \SI{10}{mm} cubes.}
  \figlabel{charp-0to2pi}
\end{figure}

\subsubsection{Experimental verification}

A series of experiments were performed on a rotated magnet assembly to verify that the re-written equations matched physical measurements.
\note{Thanks to Mr Callan Byfield for his assistance with the experimental measurements.}
An apparatus for the work of an honours project \cite{byfield2012-honoursthesis} was constructed to position two magnets relatively to each other with some fixed rotation and horizontal offset with unconstrained vertical motion (\figref{magrig}).
The vertical displacement was measured with a Wenglor CP35MHT80 laser sensor, and the base magnet was mounted to an ATI Mini85 SI-950-40 load cell to measure the reaction forces generated by the magnets.

\begin{figure}
\includegraphics{PhD/Figures/Rig/magrig-label}
\caption{Photo of the experimental apparatus to measure magnet forces.}
\figlabel{magrig}
\end{figure}

\begin{figure}
\asyinclude{\jobname/rot-geom}
\lofcaption{
  Geometry of the rotational assembly to determine magnet centre offsets.
}{
  Upper magnet rotates on a lever arm around point $O_m$ of length \SI{53}{mm} to the magnet centre.
}
\figlabel{rot-geom}
\end{figure}

The geometry of the rotational assembly is shown in \figref{rot-geom}.
A number of vertical force \vs\ vertical displacement measurements were taken for a discrete set of angle rotations $\mrot$.
Of the tests performed, two sets of results are shown in \figref{magrotmeas}: N45 \SI{15x20x10}{mm} cuboids and \maggrade{52} \SI{25x25x10}{mm} cuboids.
Experimental results match well with theoretical calculations performed using \eqref{charpz}.
Larger errors with smaller displacements are believed to be caused due to misalignment between the magnets, which would cause larger force discrepancies in the near-field of the magnetic interactions.

\begin{figure}
  \begin{wide}
  \subbottom[\SI{15x20x10}{mm} N45 cube magnets.]{\psfragfig{PhD/magrotate/Results/rot-cuboid-15x10x20}}\hfil
  \subbottom[\SI{25x25x10}{mm} \maggrade{52} cuboid magnets.]{\psfragfig{PhD/magrotate/Results/rot-cuboid-25x10x25}}
  \end{wide}
  \caption{
    Vertical force \vs\ angle of rotation for a set of vertical magnet centre displacements at zero rotation, labelled.
    Solid lines show theoretical calculations using \eqref{charpz} and circles show experimental measurements.
    As the magnets become closer together, the cases of the magnets hinder their rotation, limiting their maximum angle.
  }
  \figlabel{magrotmeas}
\end{figure}

\subsection{Torques between cuboid magnets}

\textcite{allag2009-ietm} have proposed a method, corrected later \cite{yonnet2011-ietm}, using the magnetic nodes approach to calculated the torques between cuboid magnets.
It is interesting to analyse their approach used to derive their equations, as it is not intuitive from the physics of the situation that their algorithm is valid.

The assertion given by Allag and Yonnet is that since the `forces' between the nodes of the magnets can be calculated, these corner forces can be used to calculate the applied torque on the magnets.
Their expression for the torque (on the second magnet) can be written as per the previous style in the following form:
\begin{equation}\eqlabel{torque}
\Tzz=\frac{\magn1\magn2}{4\pi\permVac}
  \sum_{i,j,k,l,p,q\in\{0,1\}^6}
  \Tzznode_{i,j,k,l,p,q}
  \cdot
  \gp{-1}^{i+j+k+l+p+q} ,
\end{equation}
where
\begin{equation}
\Tzznode_{i,j,k,l,p,q} = \cdcnrF_{j,l,q}\vect\times \Fzznode\fn{\cornerd_{i,j,k,l,p,q}} .
\eqlabel{torque-inner}
\end{equation}
The interpretation of \eqref{torque} and \eqref{torque-inner} is that the inner terms of the summation represent the torque applied on the second magnet due to the influence of one corner of the first magnet and one corner of the second magnet. Allag and Yonnet write this slightly differently in terms of the total torque applied from the entire first magnet on each corner of the second:
\begin{equation}\eqlabel{torqu-1}
\Tzz = \sum_{j,l,q\in\{0,1\}^3} \cdcnrF_{j,l,q}\vect\times \vect f_{j,l,q} ,
\end{equation}
where $\vect f_{j,l,q}$ is the summed force on a corner of the second magnet due to every corner of the first magnet, given by
\begin{equation}\eqlabel{torqu-2}
\vect f_{j,l,q}=\tfrac{\magn1\magn2}{4\pi\permVac}
  \!\!\!\sum_{i,k,p\in\{0,1\}^3}\!\!\!
  \Fzznode\fn{\magcd_{i,j,k,l,p,q}}
  \cdot
  \gp{-1}^{i+j+k+l+p+q}.
\end{equation}
In other words, written in this form the `corner torque' for each node of the second magnet is given by
\begin{equation}\eqlabel{corner-torques}
  \bm \tau_{j,l,q} = \cdcnrF_{j,l,q} \vect\times \vect f_{j,l,q}.
\end{equation}
It is easily seen that \eqref{torqu-1} and \eqref{torqu-2} are equivalent to \eqref{torque} since the inner summation in the former can be migrated out from inside the cross product.

In the interests of clarity, it should be noted that what has been referred to until now as a corner force is in fact not actually a force; rather, it is simply a mathematical abstraction (namely, the bound of an integral).
Writing the interaction between two corners as $(i,k,p)\to(j,l,q)$, consider two geometrically-symmetrical cases from the previous example with zero horizontal displacement:
\begin{itemize}
\item $(0,0,0)\to(1,0,0)$, and
\item $(1,0,0)\to(0,0,0)$.
\end{itemize}
These two interactions are depicted in \figref{mag-nodes}.
The magnetic node force calculated in these two cases are not the same, violating symmetry.

Consider a fixed magnet of size $[2a,2b,2c]\T$ reacting with another magnet of some fixed vertical distance away. Compare two cases for the second magnet:
\begin{itemize}
\item	of equal size with $[2A, 2B, 2C]\T=[2a, 2b, 2c]\T$, and
\item	of greater size with $[2A, 2B, 2C]\T=[6a, 6b, 2c]\T$.
\end{itemize}
These two cases are shown in \figref{nodes-bigsmall} highlighting the interaction between two equivalent corners.
The magnetic node force calculated for these cases show that the interaction between the further-apart nodes produces greater magnetic node forces than for the closer nodes.
This result violates the well-known inverse-displacement relationship that magnetic forces have.

Despite these two results that show that `node forces' do not behave like classical forces, the magnetic nodes approach proposed by \textcite{yonnet2011-ietm} gives  consistent results as the theory by \textcite{janssen2010-ietm}, who separately published a more general equation which derives analytical torque equations from first principles.
(Their generalisation allowed the centre of rotation to be located at an arbitrary point rather than the centre of the cuboid magnet.)
The same group later published analogous equations for the force between orthogonally-magnetised cuboid magnets \cite{janssen2011-ietm}.
The theory formalising the superposition of magnetic interations outlined in \secref{magforce-arbitary} can be used directly to calculate the torques between arbitrarily magnetised cuboid magnets.

\begin{figure}
\subbottom[Two geometrically-symmetrical node interactions.
\figlabel{mag-nodes}]
  %{\asyinclude{PhD/Figures/Magnets/mag-nodes}}
   {\includegraphics{PhD/Figures/Magnets/mag-nodes-cached}}\hfill
\subbottom[Two node interactions for a smaller magnet and a larger magnet.
\figlabel{nodes-bigsmall}]
  %{\fbox{\asyinclude{PhD/Figures/Magnets/nodes-bigsmall}}}}
  {\includegraphics{PhD/Figures/Magnets/nodes-bigsmall-cached}}
\caption{Two examples of interacting magnetic nodes.}
\end{figure}






\section{Forces between cylindrical magnets}
\seclabel{cyl-forces}
\seclabel{magnetcoil-forces}

The force equations between cylindrical magnets are more difficult to derive than for cuboid magnets since their integrals involve a cylindrical coordinate system.
In early work in this field, \textcite{cooper1973-ietm} presented an integral expression for calculating the force between two cylindical magnets.
\textcite{nagaraj1988} investigated and compared the force between cuboid and cylindrical magnets with arbitrary displacements using numerical integration to calculate his results; \citeauthor{furlani1993-ietm}~\cite{furlani1993-ietm,furlani1993-ietm-coupl} calculated the force between radially-aligned ring magnets using a numerical discretisation of the magnet volume.
\textcite{hull1999-japplphys} presented integral equations for calculating the radial and axial forces between a cylindrical magnet and a superconductor, which is equivalent to the force between two cylindrical magnets, and \textcite{bassani2006-trib-int} presented integral equations for calculating the radial and axial forces between ring magnets.
The forces between non-coaxial cylindrical magnets were considered by \textcite{agashe2008-applphys,vokoun2009-jmmm}, with the recent work of \textcite{conway2013-ietm} the most efficient solution yet presented.
All such integral equations require some degree of numerical integration to evaluate, excepting those of Furlani who uses the discretision method instead.

\textcite{babic2008-ietm} and \textcite{ravaud2010-pier} presented closed form expressions for calculating the force between pairs of thin coils (in which there are many turns axially but the coil is modelled as having zero radial thickness).
At part of the work of this thesis, a simplification of the force equation of \textcite{ravaud2010-pier} has been developed \cite{robertson2011-ietm}.
This simplification, \eqref[vref]{simpl4}, results in a faster execution time and more convenient calculation with numerical software.


\begin{figure}
\centering
\asyinclude{PhD/Figures/Coil/coil-mag-equiv.asy}
\caption
[The equivalence between a permanent magnet and a current-carrying coil.]
{The equivalence between a permanent magnet of magnetisation $J=\remanence$ (left) in the positive vertical direction, and a current-carrying coil (right) with equivalent magnetisation $J_{\text{eq.}}=\permvac \turnsCoil \current/\lengthCoil$ for current $\current$ shown flowing anti-clockwise from the top through $\turnsCoil$ axial turns across length $\lengthCoil$.}
\figlabel{coil-mag-equiv}
\end{figure}

The equation for the force between cylindrical magnets can also be used to calculate the force between thin coils with many axial turns, as both magnet and coil can be modelled as a surface current density around a cylinder (see \figref{coil-mag-equiv}). In related work, \textcite{kim1996-ietm} presented a different integral equation for the radial force between (single-turn) circular coils with eccentric radial displacement, for which further application of their results is required to calculate the forces between coils with many turns.
Little attention has been paid to the forces between rotated cylindrical magnets; \textcite{babic2011-ietm-incl-coil} presented equations for calculating the forces between rotated and eccentric (single-turn) circular coils.
These expressions can be used with superposition to calculate the forces between rotated and inclined thin-wall solenoids or permanent magnets.

\begin{figure}
\centering
\asyinclude{PhD/Figures/Systems/cyl.asy}
\lofcaption{Two-dimensional side view of the system composed of two coaxial cylindrical magnets with a generated force on the second magnet.}
{
  (While magnets are shown, either or both may be replaced by a thin coil as shown in \figref{coil-mag-equiv}.)
  Axial displacement between the magnets may be positive or negative, and their volumes may overlap in the case of a magnet located inside a coil.
  Arrows within the magnets indicate direction of magnetic polarisation.
}
\figlabel{cyl-schem}
\end{figure}

\subsubsection{Coaxial magnet force simplification}

\def\m#1{m_{#1}}
The magnetic system of interest here consists of two coaxial cylindrical magnets or current-carrying coils which have a relative axial displacement between them, as shown in \figref{cyl-schem}.
After simplification of the work of \textcite{ravaud2010-ietm}, the equation for calculating axial force $\Fax$ is given by~\cite{robertson2011-ietm}
\begin{dmath}[label=simpl4]
\Fax = \frac{\magn1 \magn2}{2\permVac} \sum_{i=1}^2 \sum_{j=3}^4 \m1\m2\m3 f_z \gp{-1}^{i+j}
\end{dmath},
where the intermediate expression $f_z$ is defined in terms of complete elliptic integrals of the first, second, and third kind ($\EllipticK{m}$, $\EllipticE{m}$, and $\EllipticPi{n,m}$, respectively)
\begin{dmath}[label=simpl4i]
f_z=
  \EllipticK{\m4}
  - \frac{1}{\m2}\EllipticE{\m4}
  +
\gdef\finalterm{
  \gp[2]{\frac{\m1^2}{\m3^2}-1} \invtimes
    \EllipticPi{\frac{\m4}{1-\m2},\m4}
}\finalterm
\end{dmath},
with parameters
\begin{align}
\m1 &= z_i - z_j, \\
\m2 &= \frac{\gp{r_1-r_2}^2}{\m1^2}+1,\\
\m3^2 &= \gp{r_1+r_2}^2+\m1^2, \\
\m4 &= \frac{4 r_1 r_2}{\m3^2}, \qquad 0<\m4\le 1.
\end{align}
This equation is particularly efficient to calculate as the complete elliptic integrals of the first, second, and third kind can all be calculated simultaneously with a single iteration of the arithmetic-geometric mean approach \cite[\S19.8(i)]{DLMF2010}.


\subsection{Numerical evaluation of the axial force}
\seclabel{numer}

Numerical singularities occur when an expression is mathematically continuous and terms within the expression approach infinity; care must be taken when evaluating such expressions numerically.
There are two numerical singularities in \eqref{simpl4}.
The first occurs when the radii are equal such that $\m2=1$ and the following term disappears as $\EllipticPi{\pm\infty,m}=0$:
\begin{dmath}
\finalterm = 0 \condition*{\m2=1}
\end{dmath}.

The second numerical singularity occurs when the magnets/coils have coincident faces such that $\m1=0$ for some values of $i$ and $j$ in the double summation. In this case, the parameter $\m2$ contains the coefficient $1/\m1^2=1/0$. This singularity can be avoided entirely since coincident faces generate no component of force between them, and hence the entire intermediate expression within the summation $\m1\m2\m3 f_z'$ can be defined as zero when $\m1=0$.

\subsection{Implementation efficiency}

Evaluated in Mathematica v6 (including branching to avoid singularities), \eqref{simpl4} took an average of 0.26\,ms on a notebook computer to calculate the force at a single location (10000 samples with random input variables). The original equation by \citeauthor{ravaud2010-ietm} in the same configuration evaluated in 2.2\,ms on average, which is over eight times slower than the new equation. For researchers performing design optimisations with variations over a large number of parameters, such an efficiency improvement is useful in minimising the total computation time of the optimisation process.



\section{Summary of the magnetic theory}

A brief introduction to the theory and terminology used in the analysis of magnetic systems has been presented.
An overview of the literature has highlighted solutions for calculating the forces, torques, and stiffnesses between permanent magnet configurations of various geometries.
The closed form solutions that have been presented are summarised in \tabref{magsummary}; this theory is used extensively in the remainder of this work.

\begin{table}
\caption{Summary of the quasi-static magnetic theory presented in the literature.}
\tablabel{magsummary}
\begin{tabular}{@{}lcl@{}}
\toprule
Geometry & Expression & Reference \\
\midrule
Parallel cuboid & $\Fzz$ & \cite{akoun1984} \\
                & $\Fzy$ & \cite{janssen2009-sensorletters,allag2009-sensorletters} \\
                & $\Tzz$ & \cite{janssen2010-ietm} \\
                & $\Tzy$ & \cite{janssen2011-ietm} \\
Cuboid rotated around $\ax$ axis  & $\force{2}$, $\force{3}$ & \secref*{french-equations} \\
Circular current loops, rotated & $\Fax$, $\Fr$ & \cite{babic2011-ietm-incl-coil} \\
Coaxial cylindrical magnet/coil & $\Fax$ & \cite{robertson2011-ietm} \\
Non-coaxial cylindrical magnet/coil & $\Fax$, $\Fr$ & \cite{conway2013-ietm} \\
\bottomrule
\end{tabular}
\end{table}

\end{document}
